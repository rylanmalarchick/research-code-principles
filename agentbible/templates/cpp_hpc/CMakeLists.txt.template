# {{PROJECT_NAME}} - C++/HPC Research Project
# Generated with AgentBible (bible init)

cmake_minimum_required(VERSION 3.18)
project({{PROJECT_NAME_UNDERSCORE}} LANGUAGES CXX)

# ============================================================================
# C++ Standard and Compiler Settings
# ============================================================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Export compile commands for IDE/LSP integration
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# ============================================================================
# Zero-Warning Policy: Warnings as Errors
# ============================================================================
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    add_compile_options(
        -Wall
        -Wextra
        -Wpedantic
        -Wshadow
        -Wconversion
        -Wsign-conversion
        -Wnon-virtual-dtor
        -Wold-style-cast
        -Wcast-align
        -Wunused
        -Woverloaded-virtual
        -Wnull-dereference
        -Wdouble-promotion
        -Wformat=2
    )
    
    # Treat warnings as errors in CI
    if(DEFINED ENV{CI})
        add_compile_options(-Werror)
    endif()
    
    # Additional GCC-specific warnings
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        add_compile_options(
            -Wmisleading-indentation
            -Wduplicated-cond
            -Wduplicated-branches
            -Wlogical-op
        )
    endif()
endif()

# ============================================================================
# CUDA Support (Optional)
# ============================================================================
option(ENABLE_CUDA "Enable CUDA support" OFF)

if(ENABLE_CUDA)
    enable_language(CUDA)
    set(CMAKE_CUDA_STANDARD 17)
    set(CMAKE_CUDA_STANDARD_REQUIRED ON)
    
    # Auto-detect CUDA architecture or set manually
    if(NOT DEFINED CMAKE_CUDA_ARCHITECTURES)
        set(CMAKE_CUDA_ARCHITECTURES native)
    endif()
endif()

# ============================================================================
# Library Target
# ============================================================================
add_library(${PROJECT_NAME}_lib
    src/core.cpp
)

target_include_directories(${PROJECT_NAME}_lib
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
)

# Add CUDA sources if enabled
if(ENABLE_CUDA)
    target_sources(${PROJECT_NAME}_lib PRIVATE
        src/cuda/kernels.cu
    )
    target_compile_definitions(${PROJECT_NAME}_lib PUBLIC CUDA_ENABLED)
endif()

# ============================================================================
# Main Executable
# ============================================================================
add_executable(${PROJECT_NAME} src/main.cpp)
target_link_libraries(${PROJECT_NAME} PRIVATE ${PROJECT_NAME}_lib)

# ============================================================================
# Testing with GoogleTest
# ============================================================================
option(BUILD_TESTS "Build test suite" ON)

if(BUILD_TESTS)
    include(FetchContent)
    FetchContent_Declare(
        googletest
        GIT_REPOSITORY https://github.com/google/googletest.git
        GIT_TAG v1.14.0
    )
    # Prevent GoogleTest from overriding compiler settings
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
    FetchContent_MakeAvailable(googletest)
    
    enable_testing()
    
    add_executable(tests
        tests/test_main.cpp
        tests/test_core.cpp
        tests/test_cuda_memory.cpp
    )
    
    target_link_libraries(tests
        PRIVATE
            ${PROJECT_NAME}_lib
            GTest::gtest_main
    )
    
    include(GoogleTest)
    gtest_discover_tests(tests)
endif()

# ============================================================================
# Documentation (Optional)
# ============================================================================
option(BUILD_DOCS "Build documentation" OFF)

if(BUILD_DOCS)
    find_package(Doxygen REQUIRED)
    
    set(DOXYGEN_GENERATE_HTML YES)
    set(DOXYGEN_GENERATE_MAN NO)
    set(DOXYGEN_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/docs)
    set(DOXYGEN_EXTRACT_ALL YES)
    set(DOXYGEN_WARN_AS_ERROR YES)
    
    doxygen_add_docs(docs
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        COMMENT "Generating API documentation"
    )
endif()
